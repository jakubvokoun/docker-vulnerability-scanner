#!/bin/sh

logger_name() {
    printf 'docker-vulnerability-scanner[%s]' "$$"
}

logger_message() {
    printf 'Docker image %s contains vulnerabilities' "$1"
}

if [ ! -f clair-scanner ]; then
    wget -O clair-scanner\
        https://github.com/arminc/clair-scanner/releases/download/v12/clair-scanner_linux_amd64
    chmod +x clair-scanner
fi

docker inspect clair-db > /dev/null && docker rm -f clair-db
docker inspect clair-scan > /dev/null && docker rm -f clair-scan

docker run -p 5432:5432 -d --name clair-db arminc/clair-db:latest
docker run -p 6060:6060 --link clair-db:postgres -d --name clair-scan \
    arminc/clair-local-scan:v2.0.6

docker images | sed '1d' | awk '{ print $1":"$2 }' | while IFS= read -r line; do
    ./clair-scanner -r out.json --ip 172.17.0.1 "$line"
    v="$(jq ".vulnerabilities | length" < out.json)"
    if [ "$v" -gt 0 ]; then
        logger -t "$(logger_name)" "$(logger_message "$line")"
    fi
    rm -f out.json
done
